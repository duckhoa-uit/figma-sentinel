## Codebase Patterns
- Use `pnpm run typecheck` from root to validate all packages
- Package structure: packages/core, packages/cli, packages/action
- Package names: @khoavhd/figma-sentinel-core, @khoavhd/figma-sentinel, @khoavhd/figma-sentinel-action
- Each package has its own tsconfig.json with NodeNext module resolution
- All packages extend tsconfig.base.json for shared compiler options
- Use .eslintrc.cjs for ESLint config (CommonJS for compatibility)
- vitest is installed at root level with --passWithNoTests for packages without tests
- Test files go in `src/__tests__/*.test.ts` within each package
- Test fixtures go in `src/__tests__/fixtures/` and must be excluded from tsconfig
- Use ESM import style for fast-glob: `import fg from 'fast-glob'`
- Use `.js` extension in imports for ESM compatibility (e.g., `from './types.js'`)

---

## 2025-01-16 - US-001
Thread: https://ampcode.com/threads/T-019bc73e-0148-701b-a29b-9e83ca62e2ad
- Initialized monorepo with pnpm workspaces
- Created root package.json with build, test, lint, typecheck scripts
- Created pnpm-workspace.yaml with packages: ['packages/*']
- Created packages/core, packages/cli, packages/action with package.json files
- Added MIT LICENSE file
- Added basic tsconfig.json for each package
- Typecheck passes
- Files changed:
  - package.json
  - pnpm-workspace.yaml
  - LICENSE
  - packages/core/package.json, packages/core/src/index.ts, packages/core/tsconfig.json
  - packages/cli/package.json, packages/cli/src/index.ts, packages/cli/tsconfig.json
  - packages/action/package.json, packages/action/src/index.ts, packages/action/tsconfig.json
- **Learnings for future iterations:**
  - tsup is used for building packages (ESM/CJS with dts)
  - vitest is used for testing
  - TypeScript devDependency is installed at root level
---

## 2025-01-16 - US-002
Thread: https://ampcode.com/threads/T-019bc740-0b20-7285-8050-c20bbf08cb4e
- Configured shared TypeScript and ESLint across all packages
- Created root tsconfig.json with project references to all packages
- Created tsconfig.base.json with shared compiler options (strict mode, noUnusedLocals, etc.)
- Updated each package tsconfig.json to extend tsconfig.base.json with composite: true
- Created .eslintrc.cjs with @typescript-eslint rules
- Created .prettierrc with consistent formatting settings
- Added ESLint and Prettier as root devDependencies
- Updated .gitignore to include *.tsbuildinfo
- Files changed:
  - package.json (added ESLint, Prettier deps, lint:fix and format scripts)
  - tsconfig.json (new - root with project references)
  - tsconfig.base.json (new - shared compiler options)
  - packages/core/tsconfig.json (extends base)
  - packages/cli/tsconfig.json (extends base, references core)
  - packages/action/tsconfig.json (extends base, references core)
  - .eslintrc.cjs (new)
  - .prettierrc (new)
  - .gitignore (added *.tsbuildinfo)
- **Learnings for future iterations:**
  - Use .eslintrc.cjs (not .js) for CommonJS ESLint config
  - composite: true required in package tsconfigs for project references
  - cli and action packages reference core package
---

## 2025-01-16 - US-003
Thread: https://ampcode.com/threads/T-019bc742-9da0-70fe-8f4c-58983031add0
- Created core package types by cloning types.ts from source repository
- Exported all types: FigmaDirective, FigmaNode, NormalizedSpec, ChangelogEntry, SentinelConfig, etc.
- Updated packages/core/src/index.ts to re-export all types
- Added zod and fast-glob as dependencies in packages/core/package.json
- Package.json exports already configured for ESM and CommonJS (from US-001)
- Typecheck passes
- Files changed:
  - packages/core/src/types.ts (new)
  - packages/core/src/index.ts (updated)
  - packages/core/package.json (added dependencies)
  - pnpm-lock.yaml
- **Learnings for future iterations:**
  - Use `.js` extension in imports for ESM compatibility (e.g., `from './types.js'`)
  - All Figma-related types are in types.ts (FigmaNode, FigmaFill, FigmaEffect, etc.)
  - SentinelConfig defines the main configuration interface
---

## 2025-01-16 - US-004
Thread: https://ampcode.com/threads/T-019bc744-c536-778b-98d7-6cd7342e9654
- Migrated normalizer module from source to packages/core/src/normalizer.ts
- Updated imports to use local types with .js extension
- Exported normalizeNode, toStableJson, createNormalizer, NormalizerConfig from index.ts
- Cloned and adapted 18 tests to packages/core/src/__tests__/normalizer.test.ts
- Installed vitest at root level
- Updated cli and action packages to use --passWithNoTests
- All 18 normalizer tests pass
- Typecheck passes
- Files changed:
  - packages/core/src/normalizer.ts (new)
  - packages/core/src/__tests__/normalizer.test.ts (new)
  - packages/core/src/index.ts (added normalizer exports)
  - packages/cli/package.json (--passWithNoTests)
  - packages/action/package.json (--passWithNoTests)
  - package.json (added vitest)
- **Learnings for future iterations:**
  - Test assertions may need adjustment for sorted keys (color object keys sorted alphabetically)
  - Use `describe` blocks from vitest for test organization
---

## 2025-01-16 - US-005
Thread: https://ampcode.com/threads/T-019bc748-28f4-7289-915a-1d77290e8186
- Migrated parser module from source to packages/core/src/parser.ts
- Updated imports to use local types with .js extension and ESM-style fast-glob import
- Exported parseFile, parseDirectives, parseDirectivesSync from index.ts
- Cloned and adapted 14 tests to packages/core/src/__tests__/parser.test.ts
- Created test fixtures directory with 7 TSX fixture files
- Added @types/node as root devDependency for node type definitions
- Updated packages/core/tsconfig.json to exclude fixtures from typecheck
- All 32 tests pass (18 normalizer + 14 parser)
- Typecheck passes
- Files changed:
  - packages/core/src/parser.ts (new)
  - packages/core/src/__tests__/parser.test.ts (new)
  - packages/core/src/__tests__/fixtures/*.tsx (7 new fixture files)
  - packages/core/src/index.ts (added parser exports)
  - packages/core/tsconfig.json (added types and exclude patterns)
  - package.json (added @types/node)
  - pnpm-lock.yaml
- **Learnings for future iterations:**
  - TSX fixture files must be excluded from TypeScript typecheck to avoid React/JSX errors
  - Use ESM import style for fast-glob: `import fg from 'fast-glob'`
  - Test fixtures go in src/__tests__/fixtures/ directory
  - Use vi.spyOn() and vi.restoreAllMocks() for console mocking in vitest
- JSON fixture files can be loaded with fs.readFileSync in tests
- Rate limit tests need increased timeout (10000ms, 30000ms) due to retry backoff
---

## 2025-01-16 - US-006
Thread: https://ampcode.com/threads/T-019bc74d-b5b9-7504-8226-6b7910d086c1
- Migrated figma-client module from source to packages/core/src/figma-client.ts
- Updated imports to use local types with .js extension
- Uses native fetch (Node 18+) with exponential backoff for rate limiting
- Exported fetchNodes, FetchedNode, FetchResult, FetchError from index.ts
- Created sample-node.json fixture in src/__tests__/fixtures/
- Adapted 12 tests to packages/core/src/__tests__/figma-client.test.ts (vitest)
- All 44 tests pass (18 normalizer + 14 parser + 12 figma-client)
- Typecheck passes
- Files changed:
  - packages/core/src/figma-client.ts (new)
  - packages/core/src/__tests__/figma-client.test.ts (new)
  - packages/core/src/__tests__/fixtures/sample-node.json (new)
  - packages/core/src/index.ts (added figma-client exports)
- **Learnings for future iterations:**
  - Use fileURLToPath and path.dirname for __dirname equivalent in ESM
  - Rate limit retry tests need increased timeout due to actual sleep delays
  - Mock fetch with vi.fn().mockResolvedValue/mockRejectedValue in vitest
---

## 2025-01-16 - US-007
Thread: https://ampcode.com/threads/T-019bc750-7e00-74f0-ab11-4cba1987aa46
- Migrated storage module from source to packages/core/src/storage.ts
- Updated imports to use local types with .js extension and local normalizer
- Exported createNormalizedSpec, saveSpec, loadSpec, loadAllSpecs, detectChanges and more from index.ts
- Created 29 unit tests in packages/core/src/__tests__/storage.test.ts
- All 73 tests pass (18 normalizer + 14 parser + 12 figma-client + 29 storage)
- Typecheck passes
- Files changed:
  - packages/core/src/storage.ts (new)
  - packages/core/src/__tests__/storage.test.ts (new)
  - packages/core/src/index.ts (added storage exports)
- **Learnings for future iterations:**
  - Storage uses fs.mkdtempSync for temp directories in tests
  - Use fs.rmSync with { recursive: true, force: true } for cleanup
  - COMPONENT_SET type nodes have variants extracted as nested specs
  - Content hash uses SHA-256 truncated to 16 chars
---
