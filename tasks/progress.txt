## Codebase Patterns
- Use `pnpm run typecheck` from root to validate all packages
- Package structure: packages/core, packages/cli, packages/action
- Package names: @khoavhd/figma-sentinel-core, @khoavhd/figma-sentinel, @khoavhd/figma-sentinel-action
- Each package has its own tsconfig.json with NodeNext module resolution
- All packages extend tsconfig.base.json for shared compiler options
- Use .eslintrc.cjs for ESLint config (CommonJS for compatibility)
- vitest is installed at root level with --passWithNoTests for packages without tests
- Test files go in `src/__tests__/*.test.ts` within each package
- Test fixtures go in `src/__tests__/fixtures/` and must be excluded from tsconfig
- Use ESM import style for fast-glob: `import fg from 'fast-glob'`
- Use `.js` extension in imports for ESM compatibility (e.g., `from './types.js'`)
- Use vi.stubGlobal('fetch', ...) in Vitest to mock global fetch
- Use fs.rmSync with { recursive: true, force: true } for test cleanup
- Cannot spy on ESM exports (child_process.spawnSync) - avoid mocking or use vi.mock at module level
- Use `while (conditionVar)` instead of `while (true)` to avoid ESLint no-constant-condition error
- CommentStyle types: 'single-line' (//, #), 'block' (/* */), 'html' (<!-- -->)
- Zod is used for config validation - use .partial() for optional fields and check unknown fields separately
- CLI uses commander v12, ora v5, execa v5 (CJS compatible versions)
- Core package uses `tsc --emitDeclarationOnly` for DTS generation (not tsup --dts) to work with project references
- Build core package before CLI to ensure .d.ts files exist for type resolution
- CLI package: remove --dts from tsup build (CLI tools don't need .d.ts files)
- CLI config: use resolveConfig(cwd, configPath?) from cli/config.ts for unified config loading with cosmiconfig
- loadConfig() returns { config, configPath } not the config directly
- ChangeDetectionResult has `changed` property not `modified`
- SentinelResult.changeResult may be undefined - use nullish coalescing for safety
- Action package: use `tsc --emitDeclarationOnly` for DTS like core (tsup --dts has issues with project references)
- For Figma Variables API: requires Enterprise plan, use @figma-variables: directive syntax
- import * as crypto from 'crypto' instead of require('crypto') to satisfy ESLint
- Use `workspace:*` in package.json dependencies for local workspace packages (resolves TypeScript issues)
- insertDirectives takes an options object: { fileKey, nodeId, filePath, content, mode }

---

# Link Command Feature Progress

Feature branch: ralph/link-command
PRD: tasks/prd-link-command.md

---

## 2026-01-17 - US-001
Thread: https://cliproxyapi-khoa.fly.dev/threads/T-019bcad9-0d4a-773b-90b1-2af5217b19ef
- Implemented `parseFigmaUrl` function in `packages/core/src/url-parser.ts`
- Parses standard design URLs (`/design/`) and legacy file URLs (`/file/`)
- Extracts file key from URL path and node ID from query params
- Handles URL-encoded node IDs (decodes `%3A` to `:`)
- Throws `FigmaUrlParseError` with descriptive messages for invalid URLs
- Rejects FigJam (`/board/`) and prototype (`/proto/`) URLs
- Exported from `packages/core/src/index.ts`
- Files changed: `packages/core/src/url-parser.ts`, `packages/core/src/index.ts`
- **Learnings for future iterations:**
  - URL parsing uses standard `new URL()` API
  - File key is the second segment in the path (after the URL type)
  - Node ID comes from `node-id` query parameter
---

## 2026-01-17 - US-002
Thread: https://cliproxyapi-khoa.fly.dev/threads/T-019bcada-9c57-704a-8ef8-87be0f9dab13
- Created comprehensive test suite for `parseFigmaUrl` function
- Tests cover: valid design URLs (with/without node ID), legacy file URLs, URL-encoded node IDs, non-Figma URLs, FigJam/prototype rejection, and malformed URLs
- 19 tests total, all passing
- Files changed: `packages/core/src/__tests__/url-parser.test.ts`
- **Learnings for future iterations:**
  - Test pattern uses `describe` blocks to group related tests
  - Use `.toThrow(ErrorClass)` and `.toThrow('message')` for testing error messages
  - Import error classes from source to verify correct error types are thrown
---

## 2026-01-17 - US-003
Thread: https://cliproxyapi-khoa.fly.dev/threads/T-019bcadc-2a09-7170-b4ab-eb3704ab6481
- Created `getCommentStyle` function in `packages/core/src/comment-style.ts`
- Returns correct comment prefix/suffix for file extensions:
  - `//` for .ts, .tsx, .js, .jsx, .swift, .kt, .go, .rs (default)
  - `#` for .py, .rb, .sh, .yaml, .yml
  - `/* */` for .css, .scss, .less
  - `<!-- -->` for .html, .vue, .svelte
- Created `formatDirective` function to format @figma-file and @figma-node directives
- Exported both functions and CommentStyle type from index.ts
- Files changed: `packages/core/src/comment-style.ts`, `packages/core/src/index.ts`
- **Learnings for future iterations:**
  - Default to C-style comments (//) for unknown extensions
  - CommentStyle interface has type, prefix, and optional suffix
---

## 2026-01-17 - US-004
Thread: https://cliproxyapi-khoa.fly.dev/threads/T-019bcade-8c4d-72e8-8754-9842d0fb31da
- Created test suite for `getCommentStyle` and `formatDirective` functions
- 32 tests total covering all supported file extensions and formatting scenarios
- Used `it.each()` pattern to test multiple extensions in a DRY manner
- Files changed: `packages/core/src/__tests__/comment-style.test.ts`
- **Learnings for future iterations:**
  - Use `it.each(array)('description %s', (value) => ...)` for parameterized tests
  - Import CommentStyle type to use with `toEqual<CommentStyle>()` for type-safe assertions
---

## 2026-01-17 - US-005
Thread: https://cliproxyapi-khoa.fly.dev/threads/T-019bcadf-d278-775c-b52e-3a142ea214c3
- Created `detectDirectives` function in `packages/core/src/directive-detector.ts`
- Detects @figma-file directive and extracts file key
- Detects all @figma-node directives and extracts node IDs (no duplicates)
- Supports detection in //, #, /* */, and HTML comment styles
- Returns `DetectedDirectives` interface: `{ hasFileDirective, fileKey, nodeIds }`
- Exported from `packages/core/src/index.ts`
- Files changed: `packages/core/src/directive-detector.ts`, `packages/core/src/index.ts`
- **Learnings for future iterations:**
  - Use multiple regex patterns for different comment styles rather than one complex pattern
  - Global regex patterns need lastIndex reset before each use
  - TypeScript requires explicit null checks for regex match groups
---

## 2026-01-17 - US-006
Thread: https://cliproxyapi-khoa.fly.dev/threads/T-019bcae2-121c-7456-b035-24bdc952703e
- Created `insertDirectives` function in `packages/core/src/directive-inserter.ts`
- Supports three modes: 'insert' (new directives), 'append' (add node to existing), 'replace' (replace all)
- Handles shebangs by inserting directives after the shebang line
- Detects and preserves original line endings (LF or CRLF)
- Adds blank line between directives and existing content
- Created convenience functions: `appendNodeDirective`, `replaceDirectives`
- Exported all functions and types from `packages/core/src/index.ts`
- Files changed: `packages/core/src/directive-inserter.ts`, `packages/core/src/index.ts`
- **Learnings for future iterations:**
  - TypeScript strict mode requires explicit undefined checks for array access
  - Use split(/\r?\n/) to handle both LF and CRLF line endings
  - Detect line ending style with content.includes('\r\n')
---

## 2026-01-17 - US-007
Thread: https://cliproxyapi-khoa.fly.dev/threads/T-019bcae4-c441-728f-8ef8-311d607c09eb
- Created test suite for `detectDirectives` function (16 tests)
- Created test suite for `insertDirectives`, `appendNodeDirective`, and `replaceDirectives` functions (25 tests)
- Tests cover: detection in //, #, /* */, <!-- --> comment styles, insertion into empty/existing files, shebang handling, line ending preservation, append/replace modes
- 41 tests total, all passing
- Files changed: `packages/core/src/__tests__/directive-detector.test.ts`, `packages/core/src/__tests__/directive-inserter.test.ts`
- **Learnings for future iterations:**
  - Vitest doesn't have `toStartWith` matcher - use `expect(str.startsWith('...')).toBe(true)` instead
  - Use `it.each()` pattern for parameterized tests
  - Import types from source for type-safe assertions with `toEqual<Type>()`
---

## 2026-01-17 - US-008
Thread: https://cliproxyapi-khoa.fly.dev/threads/T-019bcae7-8ff2-74ce-94a1-c38b26bd8ffd
- Created `linkCommand` in `packages/cli/src/commands/link.ts`
- Registered command in `packages/cli/src/index.ts` with all options
- Command accepts: Figma URL as positional arg, `-f/--file` and `-p/--path` for target files, `-y/--yes` for auto-confirm, `--force` for replacing directives, `-c/--cwd` for working directory
- Added comprehensive help text with usage examples via `addHelpText('after', ...)`
- Uses ora spinner and kleur for colored output
- Processes multiple files with summary at end
- Fixed workspace:* dependency for @khoavhd/figma-sentinel-core to use local workspace
- Files changed: `packages/cli/src/commands/link.ts`, `packages/cli/src/index.ts`, `packages/cli/package.json`
- **Learnings for future iterations:**
  - Use `workspace:*` in package.json dependencies to reference local workspace packages (fixes TypeScript resolution issues)
  - `insertDirectives` takes an options object, not separate parameters
  - Commander's `addHelpText('after', ...)` adds additional help sections after the standard help
---

## 2026-01-17 - US-009
Thread: https://cliproxyapi-khoa.fly.dev/threads/T-019bcaed-c11f-711f-b7a8-dd9acfde7f5b
- Verified all acceptance criteria already implemented in US-008
- Core logic includes: URL parsing, file validation, directive detection, directive insertion
- Uses ora spinner and kleur for user feedback
- Shows warning when URL has no node ID
- Files changed: none (verified existing implementation)
- **Learnings for future iterations:**
  - US-009 was fully implemented as part of US-008 due to natural code flow
  - All quality checks pass: typecheck, tests (340 tests), lint (warnings only)
---

## 2026-01-17 - US-010
Thread: https://cliproxyapi-khoa.fly.dev/threads/T-019bcaef-2d75-72bf-8d3f-10dcc9e13330
- Implemented conflict resolution for existing directives in `packages/cli/src/commands/link.ts`
- Added `resolveConflict` function that handles:
  - Interactive prompts with 'Add node to existing', 'Replace all', 'Cancel' options
  - 'Add node' option only shown if same file key and new node ID provided
  - Duplicate node ID detection (skips with info message)
  - Warning display when file keys don't match
- `--force` flag: always replaces without prompt
- `--yes` flag: auto-add if same key, auto-replace if different
- Uses `prompts` library for interactive selection
- Files changed: `packages/cli/src/commands/link.ts`
- **Learnings for future iterations:**
  - Use `prompts` library with type: 'select' for choice menus
  - Stop spinner before prompting (spinner.stop()) to avoid display issues
  - Check for undefined response.action to handle user Ctrl+C cancellation
---

## 2026-01-17 - US-011
Thread: https://cliproxyapi-khoa.fly.dev/threads/T-019bcaf1-4645-76a9-a900-e067169ff5c7
- Verified batch linking functionality already implemented in US-008
- Support for multiple `--file` arguments via Commander's `<path...>` syntax
- Each file processed independently with progress spinner
- Partial failures handled gracefully (continue processing remaining files)
- Summary displayed at end with success/failed/skipped/warning counts
- Files changed: none (verified existing implementation)
- **Learnings for future iterations:**
  - Commander's `<arg...>` variadic syntax automatically collects multiple values into an array
  - Batch linking was fully implemented as part of US-008 due to natural code flow
---

## 2026-01-17 - US-012
Thread: https://cliproxyapi-khoa.fly.dev/threads/T-019bcaf3-237c-74b2-8404-da27dc36de1b
- Implemented interactive mode for link command
- Added `promptForUrl()` function that prompts for Figma URL and re-prompts on invalid input
- Added `promptForFile()` function that prompts for file path and re-prompts if file doesn't exist
- Added `runInteractiveMode()` function that orchestrates the interactive flow
- After successful link: prompts "Link another file?" to link multiple files with same URL
- When no URL or file args provided, command enters interactive mode automatically
- Extracted `showSummary()` helper for code reuse between batch and interactive modes
- Files changed: `packages/cli/src/commands/link.ts`
- **Learnings for future iterations:**
  - Use `while (!isValid)` pattern for validation loops (ESLint-friendly)
  - Return null from prompt functions when user cancels (Ctrl+C) for clean abort handling
  - Interactive mode can fall back to non-interactive if URL is provided but file is not
---

## 2026-01-17 - US-013
Thread: https://cliproxyapi-khoa.fly.dev/threads/T-019bcaf5-22bc-738b-8061-ec9c899c11ba
- Created comprehensive test suite for `linkCommand` function in `packages/cli/src/__tests__/link.test.ts`
- 19 tests covering:
  - Basic link command with URL and file (design URLs, legacy file URLs, URLs without node ID)
  - `--path` alias works same as `--file`
  - Error handling for non-existent files
  - Error handling for invalid URLs (non-Figma, FigJam)
  - `--yes` flag auto-add/auto-replace behavior
  - `--force` flag replacing directives
  - Batch linking with multiple files
  - Partial batch failure continues processing
  - Duplicate node ID handling
  - `--cwd` option for relative path resolution
  - Comment style by file extension (TS, Python, CSS, HTML)
- All tests pass with typecheck and lint (warnings only)
- Files changed: `packages/cli/src/__tests__/link.test.ts`
- **Learnings for future iterations:**
  - Use vi.spyOn(process, 'exit') to mock process.exit and test error paths
  - Create test fixtures in `src/__tests__/fixtures/` directory and cleanup with fs.rmSync
  - Use `createTestFile` helper function for DRY test setup
---

## 2026-01-17 - US-014
Thread: https://cliproxyapi-khoa.fly.dev/threads/T-019bcb85-7a63-76a4-8b4b-5d2e2d070e61
- Verified US-014 was already fully implemented in a previous iteration
- `packages/cli/src/commands/init.ts` has `promptToLinkFile` function that:
  - Asks "Would you like to link a Figma file now?" after config creation
  - Prompts for Figma URL and target file using imported functions from link.ts
  - If user cancels, init still completes successfully
- `--yes` flag in init command skips the link prompt (line 269)
- All acceptance criteria verified as passing
- Files changed: `tasks/prd.json` (marked as passing)
- **Learnings for future iterations:**
  - Check if previous iterations already implemented the story before starting work
  - Init command reuses link command functions via imports for consistency
---

## 2026-01-17 - US-015
Thread: https://cliproxyapi-khoa.fly.dev/threads/T-019bcb87-2121-752c-94b5-0afd04d046ca
- Updated README.md with link command documentation
- Added `### figma-sentinel link` section after `### figma-sentinel variables`
- Included command syntax with all options (-f, -p, -y, --force, -c)
- Added "How it works" explanation and usage examples (basic, batch, force, yes)
- Updated Quick Start section with tip about link command
- Added "Easy Linking" to Features list
- Files changed: `README.md`
- **Learnings for future iterations:**
  - README sections for CLI commands follow consistent structure: syntax, options, how it works, examples
  - Use > **Tip:** for inline tips in Quick Start section
---

# Improved Error Handling Feature Progress

Feature branch: ralph/improved-error-handling
PRD: tasks/prd.json

---

## 2026-01-17 - US-001
Thread: https://cliproxyapi-khoa.fly.dev/threads/T-019bcc91-2aa0-701a-9fa6-7c301696edab
- Created `FigmaSentinelError` base class in `packages/core/src/errors.ts`
- Class extends Error with `code: string`, `cause?: Error`, and `isRetryable: boolean` properties
- Default `isRetryable` is false
- Exported from `packages/core/src/index.ts`
- Files changed: `packages/core/src/errors.ts`, `packages/core/src/index.ts`
- **Learnings for future iterations:**
  - Use readonly properties for immutable error metadata
  - Use Error.captureStackTrace for proper V8 stack traces
  - Use `.js` extension in imports for ESM compatibility
---

## 2026-01-17 - US-002
Thread: https://cliproxyapi-khoa.fly.dev/threads/T-019bcc92-7238-7788-8da8-3a9af74d6694
- Created `FigmaRateLimitError` subclass extending `FigmaSentinelError`
- Added Figma-specific properties: `retryAfterSec`, `planTier`, `rateLimitType`, `upgradeLink`
- Set `code: 'RATE_LIMIT'` and `isRetryable: true` by default
- Exported from `packages/core/src/index.ts`
- Files changed: `packages/core/src/errors.ts`, `packages/core/src/index.ts`
- **Learnings for future iterations:**
  - Extend base error class and call super() with required code/isRetryable options
  - Use Error.captureStackTrace with specific class name for proper stack traces
---

## 2026-01-17 - US-003
Thread: https://cliproxyapi-khoa.fly.dev/threads/T-019bcc93-e7f8-75fc-ad9b-551b0a051219
- Created remaining error subclasses extending `FigmaSentinelError`:
  - `FigmaAuthenticationError` with code 'AUTH_ERROR' for 401/403
  - `FigmaNotFoundError` with code 'NOT_FOUND' and `fileKey?: string` property
  - `FigmaServerError` with code 'SERVER_ERROR' for 500
  - `FigmaValidationError` with code 'VALIDATION_ERROR' for 400
  - `FigmaNetworkError` with code 'NETWORK_ERROR' and `isRetryable: true`
- All classes exported from `packages/core/src/index.ts`
- Files changed: `packages/core/src/errors.ts`, `packages/core/src/index.ts`
- **Learnings for future iterations:**
  - Use optional `options?: {}` for subclasses with optional properties
  - All error classes follow consistent structure: code, isRetryable, name, captureStackTrace
---

## 2026-01-17 - US-004
Thread: https://cliproxyapi-khoa.fly.dev/threads/T-019bcc95-9b9c-772c-8d55-4d347171288d
- Created comprehensive test suite for all error classes in `packages/core/src/__tests__/errors.test.ts`
- 48 tests covering:
  - `FigmaSentinelError`: properties, inheritance, code, message, isRetryable default, cause, stack trace
  - `FigmaRateLimitError`: extends FigmaSentinelError, code RATE_LIMIT, isRetryable=true, Figma-specific headers
  - `FigmaAuthenticationError`: code AUTH_ERROR, isRetryable=false
  - `FigmaNotFoundError`: code NOT_FOUND, fileKey property
  - `FigmaServerError`: code SERVER_ERROR
  - `FigmaValidationError`: code VALIDATION_ERROR
  - `FigmaNetworkError`: code NETWORK_ERROR, isRetryable=true
  - Error chaining with cause property (deep chain test)
- All tests pass, typecheck passes, lint passes (warnings only)
- Files changed: `packages/core/src/__tests__/errors.test.ts`
- **Learnings for future iterations:**
  - Use `toBeInstanceOf` to test error inheritance chain
  - Test both provided and default values for optional properties
  - Test cause property for error chaining across all error types
---

## 2026-01-17 - US-005
Thread: https://cliproxyapi-khoa.fly.dev/threads/T-019bcc97-e895-7218-bfb3-c4426dc1fc40
- Created `parseErrorResponse` function in `packages/core/src/error-parser.ts`
- Handles `{status, err}` format (ErrorResponsePayloadWithErrMessage)
- Handles `{error: true, status, message}` format (ErrorResponsePayloadWithErrorBoolean)
- Returns structured `ParsedErrorResponse` with status, message, and rateLimitHeaders
- Created `parseRateLimitHeaders` function to extract Retry-After and X-Figma-* headers
- Exported all functions and types from `packages/core/src/index.ts`
- Files changed: `packages/core/src/error-parser.ts`, `packages/core/src/index.ts`
- **Learnings for future iterations:**
  - Figma API has two error response formats - use type guards for safe parsing
  - Response body may not be valid JSON - handle parsing failures gracefully
  - Use `response.text()` instead of `response.json()` to handle non-JSON responses
---

## 2026-01-17 - US-006
Thread: https://cliproxyapi-khoa.fly.dev/threads/T-019bcc99-ce19-700c-9884-8e62720693df
- Verified US-006 was already fully implemented in a previous iteration (US-005)
- `parseRateLimitHeaders` function exists at error-parser.ts L76-107
- Extracts all required headers: Retry-After, X-Figma-Plan-Tier, X-Figma-Rate-Limit-Type, X-Figma-Upgrade-Link
- Returns typed `RateLimitHeaders` object with all optional fields
- Already exported from barrel file (index.ts L169, L173)
- Typecheck passes
- Files changed: `tasks/prd.json` (marked as passing)
- **Learnings for future iterations:**
  - parseRateLimitHeaders was implemented as part of US-005 parseErrorResponse implementation
  - Check if previous iterations already implemented the story before starting work
---

## 2026-01-17 - US-007
Thread: https://cliproxyapi-khoa.fly.dev/threads/T-019bcc99-ce19-700c-9884-8e62720693df
- Created comprehensive test suite for error parser in `packages/core/src/__tests__/error-parser.test.ts`
- 20 tests covering:
  - `parseRateLimitHeaders`: all headers, missing headers, invalid Retry-After
  - `parseErrorResponse`: {status, err} format, {error: true, message} format
  - Header extraction with rate limit info
  - Edge cases: empty body, non-JSON, long text, unknown JSON structures
- All tests pass, typecheck passes, lint passes (warnings only)
- Files changed: `packages/core/src/__tests__/error-parser.test.ts`
- **Learnings for future iterations:**
  - Use helper function `createResponse` to build mock Response objects
  - Test both Figma error response formats for each status code
  - Edge cases include empty body, non-JSON, and long response text
---

## 2026-01-17 - US-008
Thread: https://cliproxyapi-khoa.fly.dev/threads/T-019bcc9c-16dd-70e3-bc59-10a6dbeee3e2
- Updated `fetchWithRetry` function in `packages/core/src/figma-client.ts`
- Imported `parseRateLimitHeaders` from error-parser.ts
- On 429 response, parses headers using `parseRateLimitHeaders`
- Uses `retryAfterSec` value if present (converted to ms), otherwise falls back to exponential backoff
- Logs retry with wait time using console.warn
- Files changed: `packages/core/src/figma-client.ts`
- **Learnings for future iterations:**
  - Retry-After header is in seconds, multiply by 1000 for ms
  - Use !== undefined check for optional number properties
  - Log wait time in ms for consistency with existing code
---
