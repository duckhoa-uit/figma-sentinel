## Codebase Patterns
- Use `pnpm run typecheck` from root to validate all packages
- Package structure: packages/core, packages/cli, packages/action
- Package names: @khoavhd/figma-sentinel-core, @khoavhd/figma-sentinel, @khoavhd/figma-sentinel-action
- Each package has its own tsconfig.json with NodeNext module resolution
- All packages extend tsconfig.base.json for shared compiler options
- Use .eslintrc.cjs for ESLint config (CommonJS for compatibility)
- vitest is installed at root level with --passWithNoTests for packages without tests
- Test files go in `src/__tests__/*.test.ts` within each package
- Test fixtures go in `src/__tests__/fixtures/` and must be excluded from tsconfig
- Use ESM import style for fast-glob: `import fg from 'fast-glob'`
- Use `.js` extension in imports for ESM compatibility (e.g., `from './types.js'`)
- Use vi.stubGlobal('fetch', ...) in Vitest to mock global fetch
- Use fs.rmSync with { recursive: true, force: true } for test cleanup
- Cannot spy on ESM exports (child_process.spawnSync) - avoid mocking or use vi.mock at module level
- Use `while (conditionVar)` instead of `while (true)` to avoid ESLint no-constant-condition error
- Zod is used for config validation - use .partial() for optional fields and check unknown fields separately
- CLI uses commander v12, ora v5, execa v5 (CJS compatible versions)
- Core package uses `tsc --emitDeclarationOnly` for DTS generation (not tsup --dts) to work with project references
- Build core package before CLI to ensure .d.ts files exist for type resolution
- CLI package: remove --dts from tsup build (CLI tools don't need .d.ts files)
- CLI config: use resolveConfig(cwd, configPath?) from cli/config.ts for unified config loading with cosmiconfig
- loadConfig() returns { config, configPath } not the config directly
- ChangeDetectionResult has `changed` property not `modified`
- SentinelResult.changeResult may be undefined - use nullish coalescing for safety

---

## 2025-01-16 - US-001
Thread: https://ampcode.com/threads/T-019bc73e-0148-701b-a29b-9e83ca62e2ad
- Initialized monorepo with pnpm workspaces
- Created root package.json with build, test, lint, typecheck scripts
- Created pnpm-workspace.yaml with packages: ['packages/*']
- Created packages/core, packages/cli, packages/action with package.json files
- Added MIT LICENSE file
- Added basic tsconfig.json for each package
- Typecheck passes
- Files changed:
  - package.json
  - pnpm-workspace.yaml
  - LICENSE
  - packages/core/package.json, packages/core/src/index.ts, packages/core/tsconfig.json
  - packages/cli/package.json, packages/cli/src/index.ts, packages/cli/tsconfig.json
  - packages/action/package.json, packages/action/src/index.ts, packages/action/tsconfig.json
- **Learnings for future iterations:**
  - tsup is used for building packages (ESM/CJS with dts)
  - vitest is used for testing
  - TypeScript devDependency is installed at root level
---

## 2025-01-16 - US-002
Thread: https://ampcode.com/threads/T-019bc740-0b20-7285-8050-c20bbf08cb4e
- Configured shared TypeScript and ESLint across all packages
- Created root tsconfig.json with project references to all packages
- Created tsconfig.base.json with shared compiler options (strict mode, noUnusedLocals, etc.)
- Updated each package tsconfig.json to extend tsconfig.base.json with composite: true
- Created .eslintrc.cjs with @typescript-eslint rules
- Created .prettierrc with consistent formatting settings
- Added ESLint and Prettier as root devDependencies
- Updated .gitignore to include *.tsbuildinfo
- Files changed:
  - package.json (added ESLint, Prettier deps, lint:fix and format scripts)
  - tsconfig.json (new - root with project references)
  - tsconfig.base.json (new - shared compiler options)
  - packages/core/tsconfig.json (extends base)
  - packages/cli/tsconfig.json (extends base, references core)
  - packages/action/tsconfig.json (extends base, references core)
  - .eslintrc.cjs (new)
  - .prettierrc (new)
  - .gitignore (added *.tsbuildinfo)
- **Learnings for future iterations:**
  - Use .eslintrc.cjs (not .js) for CommonJS ESLint config
  - composite: true required in package tsconfigs for project references
  - cli and action packages reference core package
---

## 2025-01-16 - US-003
Thread: https://ampcode.com/threads/T-019bc742-9da0-70fe-8f4c-58983031add0
- Created core package types by cloning types.ts from source repository
- Exported all types: FigmaDirective, FigmaNode, NormalizedSpec, ChangelogEntry, SentinelConfig, etc.
- Updated packages/core/src/index.ts to re-export all types
- Added zod and fast-glob as dependencies in packages/core/package.json
- Package.json exports already configured for ESM and CommonJS (from US-001)
- Typecheck passes
- Files changed:
  - packages/core/src/types.ts (new)
  - packages/core/src/index.ts (updated)
  - packages/core/package.json (added dependencies)
  - pnpm-lock.yaml
- **Learnings for future iterations:**
  - Use `.js` extension in imports for ESM compatibility (e.g., `from './types.js'`)
  - All Figma-related types are in types.ts (FigmaNode, FigmaFill, FigmaEffect, etc.)
  - SentinelConfig defines the main configuration interface
---

## 2025-01-16 - US-004
Thread: https://ampcode.com/threads/T-019bc744-c536-778b-98d7-6cd7342e9654
- Migrated normalizer module from source to packages/core/src/normalizer.ts
- Updated imports to use local types with .js extension
- Exported normalizeNode, toStableJson, createNormalizer, NormalizerConfig from index.ts
- Cloned and adapted 18 tests to packages/core/src/__tests__/normalizer.test.ts
- Installed vitest at root level
- Updated cli and action packages to use --passWithNoTests
- All 18 normalizer tests pass
- Typecheck passes
- Files changed:
  - packages/core/src/normalizer.ts (new)
  - packages/core/src/__tests__/normalizer.test.ts (new)
  - packages/core/src/index.ts (added normalizer exports)
  - packages/cli/package.json (--passWithNoTests)
  - packages/action/package.json (--passWithNoTests)
  - package.json (added vitest)
- **Learnings for future iterations:**
  - Test assertions may need adjustment for sorted keys (color object keys sorted alphabetically)
  - Use `describe` blocks from vitest for test organization
---

## 2025-01-16 - US-005
Thread: https://ampcode.com/threads/T-019bc748-28f4-7289-915a-1d77290e8186
- Migrated parser module from source to packages/core/src/parser.ts
- Updated imports to use local types with .js extension and ESM-style fast-glob import
- Exported parseFile, parseDirectives, parseDirectivesSync from index.ts
- Cloned and adapted 14 tests to packages/core/src/__tests__/parser.test.ts
- Created test fixtures directory with 7 TSX fixture files
- Added @types/node as root devDependency for node type definitions
- Updated packages/core/tsconfig.json to exclude fixtures from typecheck
- All 32 tests pass (18 normalizer + 14 parser)
- Typecheck passes
- Files changed:
  - packages/core/src/parser.ts (new)
  - packages/core/src/__tests__/parser.test.ts (new)
  - packages/core/src/__tests__/fixtures/*.tsx (7 new fixture files)
  - packages/core/src/index.ts (added parser exports)
  - packages/core/tsconfig.json (added types and exclude patterns)
  - package.json (added @types/node)
  - pnpm-lock.yaml
- **Learnings for future iterations:**
  - TSX fixture files must be excluded from TypeScript typecheck to avoid React/JSX errors
  - Use ESM import style for fast-glob: `import fg from 'fast-glob'`
  - Test fixtures go in src/__tests__/fixtures/ directory
  - Use vi.spyOn() and vi.restoreAllMocks() for console mocking in vitest
- JSON fixture files can be loaded with fs.readFileSync in tests
- Rate limit tests need increased timeout (10000ms, 30000ms) due to retry backoff
---

## 2025-01-16 - US-006
Thread: https://ampcode.com/threads/T-019bc74d-b5b9-7504-8226-6b7910d086c1
- Migrated figma-client module from source to packages/core/src/figma-client.ts
- Updated imports to use local types with .js extension
- Uses native fetch (Node 18+) with exponential backoff for rate limiting
- Exported fetchNodes, FetchedNode, FetchResult, FetchError from index.ts
- Created sample-node.json fixture in src/__tests__/fixtures/
- Adapted 12 tests to packages/core/src/__tests__/figma-client.test.ts (vitest)
- All 44 tests pass (18 normalizer + 14 parser + 12 figma-client)
- Typecheck passes
- Files changed:
  - packages/core/src/figma-client.ts (new)
  - packages/core/src/__tests__/figma-client.test.ts (new)
  - packages/core/src/__tests__/fixtures/sample-node.json (new)
  - packages/core/src/index.ts (added figma-client exports)
- **Learnings for future iterations:**
  - Use fileURLToPath and path.dirname for __dirname equivalent in ESM
  - Rate limit retry tests need increased timeout due to actual sleep delays
  - Mock fetch with vi.fn().mockResolvedValue/mockRejectedValue in vitest
---

## 2025-01-16 - US-007
Thread: https://ampcode.com/threads/T-019bc750-7e00-74f0-ab11-4cba1987aa46
- Migrated storage module from source to packages/core/src/storage.ts
- Updated imports to use local types with .js extension and local normalizer
- Exported createNormalizedSpec, saveSpec, loadSpec, loadAllSpecs, detectChanges and more from index.ts
- Created 29 unit tests in packages/core/src/__tests__/storage.test.ts
- All 73 tests pass (18 normalizer + 14 parser + 12 figma-client + 29 storage)
- Typecheck passes
- Files changed:
  - packages/core/src/storage.ts (new)
  - packages/core/src/__tests__/storage.test.ts (new)
  - packages/core/src/index.ts (added storage exports)
- **Learnings for future iterations:**
  - Storage uses fs.mkdtempSync for temp directories in tests
  - Use fs.rmSync with { recursive: true, force: true } for cleanup
  - COMPONENT_SET type nodes have variants extracted as nested specs
  - Content hash uses SHA-256 truncated to 16 chars
---

## 2025-01-16 - US-008
Thread: https://ampcode.com/threads/T-019bc753-9842-776f-a985-6ef6ee4f37aa
- Migrated differ module from source to packages/core/src/differ.ts
- Updated imports to use local types with .js extension and local storage module
- Exported generateChangelogEntries, generateChangelogMarkdown, generatePRBody, diffSpecs, diffVariants, formatValue, formatColor, formatPropertyPath, getRelativeImagePath, getRelativePreviousImagePath, attachImagePaths, writeChangelog, generateChangelog from index.ts
- Added ExportedImage and ImageExportResult types to differ.ts (minimal interface for attachImagePaths)
- Created 46 comprehensive tests in packages/core/src/__tests__/differ.test.ts
- All 119 tests pass (18 normalizer + 14 parser + 12 figma-client + 29 storage + 46 differ)
- Typecheck passes
- Files changed:
  - packages/core/src/differ.ts (new)
  - packages/core/src/__tests__/differ.test.ts (new)
  - packages/core/src/index.ts (added differ exports)
- **Learnings for future iterations:**
  - No source test file existed for differ - created comprehensive tests from scratch
  - ExportedImage/ImageExportResult types defined locally in differ.ts to avoid circular dependency with image-exporter
  - formatColor outputs uppercase hex with optional opacity percentage
  - formatPropertyPath transforms technical paths to human-readable labels (fills -> Fill, fontSize -> font size)
---

## 2025-01-16 - US-009
Thread: https://ampcode.com/threads/T-019bc758-0987-734a-acee-b309df02f85a
- Migrated image-exporter module from source to packages/core/src/image-exporter.ts
- Updated imports to use local types with .js extension and local storage module for sanitizeNodeId
- Exported exportImages, exportImagesForMultipleFiles, cleanupRemovedImages, getImagePath, getPreviousImagePath from index.ts
- Also exported ExportedImage, ImageExportResult, ImageExportError, ExportImagesInput types
- Updated differ.ts to import ExportedImage/ImageExportResult from image-exporter instead of defining locally
- Adapted 18 tests to packages/core/src/__tests__/image-exporter.test.ts (converted from Jest to Vitest)
- All 137 tests pass (18 normalizer + 14 parser + 12 figma-client + 29 storage + 46 differ + 18 image-exporter)
- Typecheck passes
- Files changed:
  - packages/core/src/image-exporter.ts (new)
  - packages/core/src/__tests__/image-exporter.test.ts (new)
  - packages/core/src/index.ts (added image-exporter exports)
  - packages/core/src/differ.ts (import types from image-exporter)
- **Learnings for future iterations:**
  - Use vi.stubGlobal('fetch', ...) in Vitest to mock global fetch
  - ExportedImage has `imagePath` field (not `path`)
  - Use fs.rmSync with { recursive: true, force: true } for test cleanup
  - Image paths use sanitizeNodeId from storage module (e.g., 1:23 -> 1-23.png)
---

## 2025-01-16 - US-010
Thread: https://ampcode.com/threads/T-019bc75c-95db-7409-99e2-e48a5c755bb7
- Migrated markdown-exporter module from source to packages/core/src/markdown-exporter.ts
- Updated imports to use local types with .js extension and local storage module for sanitizeNodeId
- Exported exportSpecsAsMarkdown, generateMarkdownFromSpec, isFigmaExtractorAvailable, getMarkdownFilePath, generateMarkdownWithExtractor, saveMarkdownSpec, exportSpecAsMarkdown, removeMarkdownSpec, MarkdownExportResult from index.ts
- Created 25 unit tests in packages/core/src/__tests__/markdown-exporter.test.ts
- All 162 tests pass (18 normalizer + 14 parser + 12 figma-client + 29 storage + 46 differ + 18 image-exporter + 25 markdown-exporter)
- Typecheck passes
- Files changed:
  - packages/core/src/markdown-exporter.ts (new)
  - packages/core/src/__tests__/markdown-exporter.test.ts (new)
  - packages/core/src/index.ts (added markdown-exporter exports)
- **Learnings for future iterations:**
  - Cannot spy on ESM module exports directly (spawnSync) - use vi.mock instead or skip mocking when not needed
  - Markdown exporter optionally uses figma-extractor binary if available, otherwise falls back to built-in generation
  - extractColors, extractTypography, extractLayoutRules, extractCornerRadius, extractEffects are internal helpers
  - Use console.info for informational messages (not warnings/errors) about optional features
---

## 2025-01-16 - US-011
Thread: https://ampcode.com/threads/T-019bc762-1157-700a-a4d4-13c9b1a186a6
- Created runSentinel orchestrator in packages/core/src/sentinel.ts
- Migrated from source index.ts, keeping only runSentinel function and types
- Removed CLI main() function (will go in CLI package per US-014)
- Added SentinelOptions.config parameter to allow passing config directly
- Included inline config loading (minimal version - full Zod validation in US-012)
- Exported runSentinel, SentinelResult, SentinelOptions, DEFAULT_CONFIG from index.ts
- Created 23 comprehensive tests in packages/core/src/__tests__/sentinel.test.ts
- All 185 tests pass (18 normalizer + 14 parser + 12 figma-client + 29 storage + 46 differ + 18 image-exporter + 25 markdown-exporter + 23 sentinel)
- Typecheck passes
- Files changed:
  - packages/core/src/sentinel.ts (new)
  - packages/core/src/__tests__/sentinel.test.ts (new)
  - packages/core/src/index.ts (added sentinel exports)
- **Learnings for future iterations:**
  - runSentinel accepts config via options parameter OR loads from filesystem
  - Use `while (continueSearch)` instead of `while (true)` to avoid ESLint no-constant-condition error
  - SentinelResult includes changeResult, changelogPath, prBodyPath for CI integrations
  - Integration tests mock fetch with vi.stubGlobal and create temp directories with fixture files
---

## 2025-01-16 - US-012
Thread: https://cliproxyapi-khoa.fly.dev/threads/T-019bc767-8e73-72db-b41b-f7b2b634fd1f
- Migrated config module from source to packages/core/src/config.ts
- Replaced manual validation with Zod schema (SentinelConfigSchema)
- Kept DEFAULT_CONFIG, mergeConfig, createDefaultConfigFile, loadConfig, loadConfigFromFile functions
- Exported validateConfig, loadConfig, DEFAULT_CONFIG, SentinelConfigSchema, and more from index.ts
- Updated sentinel.ts to import config utilities from config.js instead of defining locally
- Created 37 comprehensive unit tests in packages/core/src/__tests__/config.test.ts
- All 222 tests pass (185 previous + 37 config tests)
- Typecheck passes
- Files changed:
  - packages/core/src/config.ts (new)
  - packages/core/src/__tests__/config.test.ts (new)
  - packages/core/src/index.ts (added config exports)
  - packages/core/src/sentinel.ts (removed duplicate code, imports from config.js)
- **Learnings for future iterations:**
  - Zod .partial() allows all fields to be optional for partial validation
  - Unknown field validation must be done separately since Zod ignores unknown fields by default
  - Use `while (continueSearch)` pattern from config.ts findConfigFile (pattern already established)
  - Config module exports SentinelConfigSchema for programmatic validation
---

## 2025-01-16 - US-014
Thread: https://cliproxyapi-khoa.fly.dev/threads/T-019bc76f-81f7-757d-93ff-9d91dd451800
- Implemented CLI sync command in packages/cli/src/commands/sync.ts
- Uses ora spinner for 'Scanning for directives...', 'Fetching from Figma...', 'Detecting changes...'
- Uses kleur for colorized success/error/warning messages
- Supports --dry-run, --cwd, --config flags
- Exit 0 on success, 1 on error
- Fixed core package build to generate .d.ts files (added tsc --emitDeclarationOnly after tsup)
- Added tsup as root devDependency
- Typecheck passes, all 222 tests pass
- Files changed:
  - packages/cli/src/commands/sync.ts (new)
  - packages/cli/src/index.ts (imports and uses syncCommand)
  - packages/core/package.json (fixed DTS generation)
  - package.json (added tsup devDependency)
  - pnpm-lock.yaml
- **Learnings for future iterations:**
  - tsup DTS generation can fail with project references - use tsc --emitDeclarationOnly instead
  - CLI packages need core package to be built first so .d.ts files exist
  - Use ora v5 (not v6+) for CJS compatibility
  - Suppress console output from core runSentinel when using spinners
---

## 2025-01-16 - US-013
Thread: https://ampcode.com/threads/T-019bc774-aec1-76eb-bca3-766d4cbba311
- CLI package structure already complete from previous iterations (US-001, US-014)
- Verified packages/cli/package.json has bin entry pointing to dist/index.js
- Verified all required dependencies are present: commander, prompts, ora, kleur, cosmiconfig, fs-extra, execa
- Verified @khoavhd/figma-sentinel-core workspace dependency is configured
- Verified packages/cli/src/index.ts has shebang and commander setup
- Typecheck passes
- Files verified (no changes needed):
  - packages/cli/package.json
  - packages/cli/src/index.ts
- **Learnings for future iterations:**
  - CLI package was incrementally built across multiple stories
  - US-001 created initial structure, US-014 added sync command and all dependencies
---

## 2025-01-16 - US-015
Thread: https://ampcode.com/threads/T-019bc775-ea7c-701d-b8df-63861afe7414
- Implemented CLI check command in packages/cli/src/commands/check.ts
- Uses ora spinner for checking FIGMA_TOKEN, configuration, and scanning directives
- Uses kleur for colorized success/error/warning messages
- Checks for config file existence and validity using core's validateConfig
- Checks for FIGMA_TOKEN environment variable (warns if not set)
- Parses directives and reports count without fetching from Figma
- Displays summary: X files with directives, Y total nodes, Z unique Figma files
- Shows detailed file list with file keys and node IDs
- Supports --cwd, --config flags
- Exit 0 on success, 1 on warnings/errors
- Typecheck passes, all 222 tests pass
- Files changed:
  - packages/cli/src/commands/check.ts (new)
  - packages/cli/src/index.ts (imports and uses checkCommand)
- **Learnings for future iterations:**
  - CLI check command provides dry-run validation without Figma API calls
  - Use ora spinner's warn() method for non-fatal warnings (FIGMA_TOKEN not set)
  - Suppress loadConfig's console.log by temporarily overriding console.log
  - Show detailed summary with file paths relative to cwd for better readability
---

## 2025-01-16 - US-016
Thread: https://ampcode.com/threads/T-019bc778-ca3a-720a-b658-c6ad77ec9a79
- Implemented CLI diff command in packages/cli/src/commands/diff.ts
- Accepts node-id as positional argument with validation
- Fetches current node from Figma API using fetchNodes from core
- Loads existing spec from .design-specs using loadSpec from core
- Displays side-by-side diff of properties with colors (kleur)
- Uses diffSpecs, formatValue, formatPropertyPath from core for change detection
- Highlights previous values in red, new values in green
- Supports --file-key, --cwd, --config flags
- Uses ora spinner for loading states
- Removed --dts from CLI build script (CLI doesn't need type definitions)
- Removed types field from CLI package.json
- All 222 tests pass, typecheck passes
- Files changed:
  - packages/cli/src/commands/diff.ts (new)
  - packages/cli/src/index.ts (imports and uses diffCommand)
  - packages/cli/package.json (removed --dts flag and types field)
- **Learnings for future iterations:**
  - CLI tools don't need .d.ts files, remove --dts from tsup build
  - Use `const` for variables that are validated but not reassigned (prefer-const)
  - Cast `unknown` node types to `Record<string, unknown>` for property iteration
  - Use early return with null check for array index access to avoid TS18048 errors
---

## 2025-01-16 - US-017
Thread: https://ampcode.com/threads/T-019bc77e-682e-71ff-9eaa-fbdf80087c55
- Implemented CLI init command in packages/cli/src/commands/init.ts
- Uses prompts for interactive config setup: format (js/json/package.json), specs directory, file patterns, export images, image scale
- Supports JS config (figma-sentinel.config.js), JSON config (.figma-sentinelrc.json), and package.json key
- Checks for existing config and prompts for overwrite confirmation
- Generates config file based on user selection with proper content for each format
- Displays next steps after creation with example directive syntax
- Supports --cwd flag for working directory
- Uses ora spinner for creation status, kleur for colored output
- Typecheck passes, all 222 tests pass
- Files changed:
  - packages/cli/src/commands/init.ts (new)
  - packages/cli/src/index.ts (imports and uses initCommand)
- **Learnings for future iterations:**
  - Use explicit type annotations (p: string) in map callbacks to avoid implicit any errors
  - prompts library allows select, text, confirm, number prompt types
  - Always check if config file exists before creating to avoid accidental overwrites
  - Use <keyof AnswerType> generic with prompts for type safety
---

## 2025-01-16 - US-018
Thread: https://cliproxyapi-khoa.fly.dev/threads/T-019bc781-2739-7348-ae24-ff4c55571e8b
- Implemented cosmiconfig loader in packages/cli/src/config.ts
- Uses cosmiconfig with moduleName 'figma-sentinel' for flexible config search
- Supports: package.json (figma-sentinel key), .figma-sentinelrc*, figma-sentinel.config.js/cjs
- Merges loaded config with defaults from core using mergeConfig
- Validates configuration with Zod schema from core using validateConfig
- Implements config caching for performance within single CLI run (clearConfigCache to reset)
- Updated sync, check, diff commands to use new resolveConfig function
- Removed manual config loading code from commands (cleaner and more consistent)
- All 222 tests pass, typecheck passes
- Files changed:
  - packages/cli/src/config.ts (new)
  - packages/cli/src/commands/sync.ts (uses resolveConfig)
  - packages/cli/src/commands/check.ts (simplified, uses resolveConfig)
  - packages/cli/src/commands/diff.ts (uses resolveConfig)
- **Learnings for future iterations:**
  - cosmiconfig v9 uses named exports: `import { cosmiconfig } from 'cosmiconfig'`
  - Use CosmiconfigResult type from cosmiconfig for type-safe result handling
  - Cache implementation uses module-level variables (simple but effective for CLI)
  - resolveConfig(cwd, configPath?) provides unified API for commands
---

## 2025-01-16 - US-019
Thread: https://cliproxyapi-khoa.fly.dev/threads/T-019bc784-ef31-7217-84de-38b45fc8b55e
- Created GitHub Action structure in packages/action/action.yml
- Defined action metadata with name, description, branding (layers icon, purple color)
- Added inputs: figma-token (required), config-path, dry-run, create-pr, pr-title, pr-labels
- Added outputs: has-changes, changelog-path, pr-number, pr-url
- Added dependencies: @actions/core, @actions/github, @actions/exec, @khoavhd/figma-sentinel-core
- Updated src/index.ts with placeholder implementation using @actions/core
- Uses node20 runtime for GitHub Actions
- All 222 tests pass, typecheck passes
- Files changed:
  - packages/action/action.yml (new)
  - packages/action/package.json (added dependencies)
  - packages/action/src/index.ts (updated with @actions/core usage)
  - pnpm-lock.yaml
- **Learnings for future iterations:**
  - GitHub Actions use action.yml at package root to define inputs/outputs
  - Use node20 as the runtime (LTS version)
  - @actions/core provides getInput, setOutput, setFailed, exportVariable
  - Action package should include action.yml in files array for npm publishing
---

## 2025-01-16 - US-020
Thread: https://cliproxyapi-khoa.fly.dev/threads/T-019bc788-66f4-75da-861e-6c24411aecf7
- Implemented GitHub Action main script in packages/action/src/index.ts
- Fixed TypeScript errors: loadConfig returns LoadConfigResult with .config property
- Fixed ChangeDetectionResult usage: uses `changed` not `modified`, and may be undefined
- Uses @actions/core getInput/setOutput for input/output handling
- Sets FIGMA_TOKEN from input to environment via core.exportVariable
- Calls runSentinel from core package with config and dryRun options
- Sets outputs: has-changes (boolean as string), changelog-path
- Uses core.setFailed on errors for proper GitHub Actions error handling
- All 222 tests pass, typecheck passes
- Files changed:
  - packages/action/src/index.ts (fixed type errors)
- **Learnings for future iterations:**
  - loadConfig() returns { config, configPath } not the config directly
  - ChangeDetectionResult has `changed` property not `modified`
  - SentinelResult.changeResult may be undefined - use nullish coalescing for safety
---

## 2025-01-16 - US-021
Thread: https://ampcode.com/threads/T-019bc78b-9a30-75de-b411-5878a369a4f8
- Implemented PR creation module in packages/action/src/pr.ts
- createOrUpdatePR function uses @actions/github Octokit to create/update PRs
- Reads PR body from generated PR_BODY.md file (result.prBodyPath)
- Supports configurable title, labels, and reviewers from inputs
- Checks for existing open PR on the branch and updates instead of creating new
- Sets pr-number and pr-url outputs on success
- Added pr-reviewers input to action.yml for requesting reviewers
- Added parseLabels and parseReviewers helpers to split comma-separated input strings
- Added getCurrentBranch and getBaseBranch helpers using github.context
- Updated index.ts to integrate PR creation when create-pr=true and hasChanges=true
- All 222 tests pass, typecheck passes
- Files changed:
  - packages/action/src/pr.ts (new)
  - packages/action/src/index.ts (integrated PR creation)
  - packages/action/action.yml (added pr-reviewers input)
- **Learnings for future iterations:**
  - Use nested if check for array index access to avoid TS18048 "possibly undefined" errors
  - @actions/github getOctokit requires GITHUB_TOKEN environment variable
  - github.context provides repo owner/name and event context (eventName, ref, payload)
  - PR creation skipped in dry-run mode for safety
---

## 2025-01-16 - US-022
Thread: https://cliproxyapi-khoa.fly.dev/threads/T-019bc78e-991e-765a-b115-6a2593d37907
- Created .github/workflows/ci.yml for automated CI testing
- Runs on push to main and pull_request events
- Uses pnpm/action-setup@v4 with pnpm 9
- Uses setup-node@v4 with cache enabled
- Build matrix: Node 18 and Node 20
- Steps: checkout, setup pnpm, setup node, install, build, lint, typecheck, test
- Added concurrency group to cancel in-progress runs on same ref
- All 222 tests pass, typecheck passes
- Files changed:
  - .github/workflows/ci.yml (new)
- **Learnings for future iterations:**
  - Use pnpm/action-setup@v4 for pnpm installation in GitHub Actions
  - Use --frozen-lockfile for reproducible installs in CI
  - Add concurrency group to avoid redundant CI runs
---

## 2025-01-16 - US-023
Thread: https://ampcode.com/threads/T-019bc790-248f-72ba-b612-41b094fac7c9
- Added @changesets/cli as dev dependency for versioning and publishing
- Created .changeset/config.json with access: public for npm publishing
- Created .github/workflows/release.yml for automated publishing
- Workflow triggers on push to main, uses changesets/action@v1
- Added changeset, version, and release scripts to root package.json
- Configured with id-token permission for npm provenance
- All 222 tests pass, typecheck passes
- Files changed:
  - .changeset/config.json (new)
  - .github/workflows/release.yml (new)
  - package.json (added changeset scripts and @changesets/cli dep)
  - pnpm-lock.yaml
- **Learnings for future iterations:**
  - Use changesets/action@v1 for GitHub Actions integration
  - NPM_TOKEN secret required for npm publishing
  - id-token: write permission needed for npm provenance
  - Use pnpm changeset publish for monorepo package publishing
---

## 2025-01-16 - US-025
Thread: https://cliproxyapi-khoa.fly.dev/threads/T-019bc794-6086-75bf-80af-9ac2b5140644
- Created example workflow files for users to copy and customize
- Created examples/workflows/scheduled-sync.yml for cron-based daily sync
- Created examples/workflows/on-push-sync.yml for push-triggered sync with path filters
- Created examples/workflows/manual-sync.yml for workflow_dispatch with configurable inputs
- All workflows include detailed comments explaining each section
- Features: PR creation, notifications, debug mode, artifact uploads, job summaries
- Typecheck passes
- Files changed:
  - examples/workflows/scheduled-sync.yml (new)
  - examples/workflows/on-push-sync.yml (new)
  - examples/workflows/manual-sync.yml (new)
- **Learnings for future iterations:**
  - Use workflow_dispatch inputs for configurable manual triggers
  - GITHUB_STEP_SUMMARY for rich job output
  - Concurrency groups prevent overlapping runs
---

## 2025-01-16 - US-024
Thread: https://cliproxyapi-khoa.fly.dev/threads/T-019bc792-06b0-74bd-9ca3-986bab809cf9
- Created comprehensive README.md with project overview and features
- Added Installation section covering npm, pnpm, and GitHub Action
- Added Quick Start guide with directive syntax examples
- Added Configuration section with all options and defaults table
- Added CLI Commands section (sync, check, init, diff) with examples
- Added GitHub Action Usage with basic and advanced workflow examples
- Added Programmatic Usage section for core library
- Added Output Structure section explaining .design-specs directory layout
- All 222 tests pass, typecheck passes
- Files changed:
  - README.md (new)
- **Learnings for future iterations:**
  - README structure follows: Overview → Features → Installation → Quick Start → Configuration → CLI → Action → Programmatic → Output → Contributing → License
  - Use tables for configuration options and action inputs/outputs for clarity
  - Include code examples for all major features
---
