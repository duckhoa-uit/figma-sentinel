## Codebase Patterns
- Use `pnpm run typecheck` from root to validate all packages
- Package structure: packages/core, packages/cli, packages/action
- Package names: @khoavhd/figma-sentinel-core, @khoavhd/figma-sentinel, @khoavhd/figma-sentinel-action
- Each package has its own tsconfig.json with NodeNext module resolution
- All packages extend tsconfig.base.json for shared compiler options
- Use .eslintrc.cjs for ESLint config (CommonJS for compatibility)
- vitest is installed at root level with --passWithNoTests for packages without tests
- Test files go in `src/__tests__/*.test.ts` within each package
- Test fixtures go in `src/__tests__/fixtures/` and must be excluded from tsconfig
- Use ESM import style for fast-glob: `import fg from 'fast-glob'`
- Use `.js` extension in imports for ESM compatibility (e.g., `from './types.js'`)
- Use vi.stubGlobal('fetch', ...) in Vitest to mock global fetch
- Use fs.rmSync with { recursive: true, force: true } for test cleanup
- Cannot spy on ESM exports (child_process.spawnSync) - avoid mocking or use vi.mock at module level
- Use `while (conditionVar)` instead of `while (true)` to avoid ESLint no-constant-condition error
- CommentStyle types: 'single-line' (//, #), 'block' (/* */), 'html' (<!-- -->)
- Zod is used for config validation - use .partial() for optional fields and check unknown fields separately
- CLI uses commander v12, ora v5, execa v5 (CJS compatible versions)
- Core package uses `tsc --emitDeclarationOnly` for DTS generation (not tsup --dts) to work with project references
- Build core package before CLI to ensure .d.ts files exist for type resolution
- CLI package: remove --dts from tsup build (CLI tools don't need .d.ts files)
- CLI config: use resolveConfig(cwd, configPath?) from cli/config.ts for unified config loading with cosmiconfig
- loadConfig() returns { config, configPath } not the config directly
- ChangeDetectionResult has `changed` property not `modified`
- SentinelResult.changeResult may be undefined - use nullish coalescing for safety
- Action package: use `tsc --emitDeclarationOnly` for DTS like core (tsup --dts has issues with project references)
- For Figma Variables API: requires Enterprise plan, use @figma-variables: directive syntax
- import * as crypto from 'crypto' instead of require('crypto') to satisfy ESLint

---

# Link Command Feature Progress

Feature branch: ralph/link-command
PRD: tasks/prd-link-command.md

---

## 2026-01-17 - US-001
Thread: https://cliproxyapi-khoa.fly.dev/threads/T-019bcad9-0d4a-773b-90b1-2af5217b19ef
- Implemented `parseFigmaUrl` function in `packages/core/src/url-parser.ts`
- Parses standard design URLs (`/design/`) and legacy file URLs (`/file/`)
- Extracts file key from URL path and node ID from query params
- Handles URL-encoded node IDs (decodes `%3A` to `:`)
- Throws `FigmaUrlParseError` with descriptive messages for invalid URLs
- Rejects FigJam (`/board/`) and prototype (`/proto/`) URLs
- Exported from `packages/core/src/index.ts`
- Files changed: `packages/core/src/url-parser.ts`, `packages/core/src/index.ts`
- **Learnings for future iterations:**
  - URL parsing uses standard `new URL()` API
  - File key is the second segment in the path (after the URL type)
  - Node ID comes from `node-id` query parameter
---

## 2026-01-17 - US-002
Thread: https://cliproxyapi-khoa.fly.dev/threads/T-019bcada-9c57-704a-8ef8-87be0f9dab13
- Created comprehensive test suite for `parseFigmaUrl` function
- Tests cover: valid design URLs (with/without node ID), legacy file URLs, URL-encoded node IDs, non-Figma URLs, FigJam/prototype rejection, and malformed URLs
- 19 tests total, all passing
- Files changed: `packages/core/src/__tests__/url-parser.test.ts`
- **Learnings for future iterations:**
  - Test pattern uses `describe` blocks to group related tests
  - Use `.toThrow(ErrorClass)` and `.toThrow('message')` for testing error messages
  - Import error classes from source to verify correct error types are thrown
---

## 2026-01-17 - US-003
Thread: https://cliproxyapi-khoa.fly.dev/threads/T-019bcadc-2a09-7170-b4ab-eb3704ab6481
- Created `getCommentStyle` function in `packages/core/src/comment-style.ts`
- Returns correct comment prefix/suffix for file extensions:
  - `//` for .ts, .tsx, .js, .jsx, .swift, .kt, .go, .rs (default)
  - `#` for .py, .rb, .sh, .yaml, .yml
  - `/* */` for .css, .scss, .less
  - `<!-- -->` for .html, .vue, .svelte
- Created `formatDirective` function to format @figma-file and @figma-node directives
- Exported both functions and CommentStyle type from index.ts
- Files changed: `packages/core/src/comment-style.ts`, `packages/core/src/index.ts`
- **Learnings for future iterations:**
  - Default to C-style comments (//) for unknown extensions
  - CommentStyle interface has type, prefix, and optional suffix
---

## 2026-01-17 - US-004
Thread: https://cliproxyapi-khoa.fly.dev/threads/T-019bcade-8c4d-72e8-8754-9842d0fb31da
- Created test suite for `getCommentStyle` and `formatDirective` functions
- 32 tests total covering all supported file extensions and formatting scenarios
- Used `it.each()` pattern to test multiple extensions in a DRY manner
- Files changed: `packages/core/src/__tests__/comment-style.test.ts`
- **Learnings for future iterations:**
  - Use `it.each(array)('description %s', (value) => ...)` for parameterized tests
  - Import CommentStyle type to use with `toEqual<CommentStyle>()` for type-safe assertions
---
