{
  "project": "figma-sentinel",
  "branchName": "ralph/link-command",
  "description": "Add a link command to figma-sentinel CLI that allows users to add Figma directives from URLs instead of manually typing them",
  "userStories": [
    {
      "id": "US-001",
      "title": "Create URL parser utility in core package",
      "description": "As a developer, I need a utility to parse Figma URLs and extract file keys and node IDs.",
      "acceptanceCriteria": [
        "Create `packages/core/src/url-parser.ts` with `parseFigmaUrl` function",
        "Parse standard Figma design URLs: `https://www.figma.com/design/<fileKey>/<fileName>?node-id=<nodeId>`",
        "Parse legacy file URLs: `https://www.figma.com/file/<fileKey>/<fileName>?node-id=<nodeId>`",
        "Extract `fileKey` from URL path",
        "Extract `nodeId` from URL query parameter (return null if not present)",
        "Handle URL-encoded node IDs (e.g., `1%3A23` → `1:23`)",
        "Throw descriptive error for invalid/unsupported URL formats",
        "Reject FigJam (`/board/`) and prototype (`/proto/`) URLs with specific error messages",
        "Export from `packages/core/src/index.ts`",
        "Typecheck passes"
      ],
      "priority": 1,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-002",
      "title": "Add URL parser tests",
      "description": "As a developer, I need tests to verify the URL parser works correctly.",
      "acceptanceCriteria": [
        "Create `packages/core/src/__tests__/url-parser.test.ts`",
        "Test parsing valid design URL with node ID",
        "Test parsing valid design URL without node ID",
        "Test parsing legacy file URL with and without node ID",
        "Test URL-encoded node IDs",
        "Test rejection of non-Figma URLs",
        "Test rejection of FigJam and prototype URLs",
        "Test rejection of malformed URLs",
        "All tests pass",
        "Typecheck passes"
      ],
      "priority": 2,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-003",
      "title": "Create comment style detection utility",
      "description": "As a developer, I need a utility to determine the correct comment syntax for different file types.",
      "acceptanceCriteria": [
        "Create `packages/core/src/comment-style.ts` with `getCommentStyle` function",
        "Return `//` style for `.ts`, `.tsx`, `.js`, `.jsx`, `.swift`, `.kt`, `.go`, `.rs`",
        "Return `#` style for `.py`, `.rb`, `.sh`, `.yaml`, `.yml`",
        "Return `/* */` style for `.css`, `.scss`, `.less`",
        "Return `<!-- -->` style for `.html`, `.vue`, `.svelte`",
        "Default to `//` for unknown extensions",
        "Add `formatDirective(fileKey, nodeId, filePath)` function that formats directives with correct comment style",
        "Export from `packages/core/src/index.ts`",
        "Typecheck passes"
      ],
      "priority": 3,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-004",
      "title": "Add comment style detection tests",
      "description": "As a developer, I need tests to verify comment style detection works correctly.",
      "acceptanceCriteria": [
        "Create `packages/core/src/__tests__/comment-style.test.ts`",
        "Test all supported file extensions return correct comment style",
        "Test unknown extensions default to `//`",
        "Test `formatDirective` generates correct output for each style",
        "All tests pass",
        "Typecheck passes"
      ],
      "priority": 4,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-005",
      "title": "Create directive detection utility",
      "description": "As a developer, I need a utility to detect existing Figma directives in source files.",
      "acceptanceCriteria": [
        "Create `packages/core/src/directive-detector.ts` with `detectDirectives` function",
        "Detect existing `@figma-file` directive and extract file key",
        "Detect existing `@figma-node` directives and extract all node IDs",
        "Support detection in `//`, `#`, `/* */`, and `<!-- -->` comment styles",
        "Return `{ hasFileDirective: boolean, fileKey: string | null, nodeIds: string[] }`",
        "Export from `packages/core/src/index.ts`",
        "Typecheck passes"
      ],
      "priority": 5,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-006",
      "title": "Create directive insertion utility",
      "description": "As a developer, I need a utility to insert directives at the top of source files.",
      "acceptanceCriteria": [
        "Create `packages/core/src/directive-inserter.ts` with `insertDirectives` function",
        "Insert directives at the very top of the file",
        "Preserve existing file content below inserted directives",
        "Add blank line between directives and existing content",
        "Handle files with shebang (`#!/...`) by inserting after shebang",
        "Preserve file's original line endings (LF or CRLF)",
        "Support adding node to existing file key (append `@figma-node` line)",
        "Support replacing all directives",
        "Export from `packages/core/src/index.ts`",
        "Typecheck passes"
      ],
      "priority": 6,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-007",
      "title": "Add directive detection and insertion tests",
      "description": "As a developer, I need tests for directive detection and insertion.",
      "acceptanceCriteria": [
        "Create `packages/core/src/__tests__/directive-detector.test.ts`",
        "Create `packages/core/src/__tests__/directive-inserter.test.ts`",
        "Test detection of existing directives in various comment styles",
        "Test insertion into empty files",
        "Test insertion into files with existing content",
        "Test insertion after shebang",
        "Test adding node to existing directives",
        "Test replacing directives",
        "All tests pass",
        "Typecheck passes"
      ],
      "priority": 7,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-008",
      "title": "Create basic link command structure",
      "description": "As a developer, I need the basic CLI command structure for the link command.",
      "acceptanceCriteria": [
        "Create `packages/cli/src/commands/link.ts`",
        "Register command in `packages/cli/src/index.ts`",
        "Accept Figma URL as optional positional argument",
        "Accept `--file` or `-f` option for target file path",
        "Accept `--path` or `-p` as alias for `--file`",
        "Accept `--yes` or `-y` flag to skip confirmations",
        "Accept `--force` flag to replace existing directives",
        "Accept `--cwd` or `-c` flag for working directory",
        "Show help text with examples when run with `--help`",
        "Typecheck passes"
      ],
      "priority": 8,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-009",
      "title": "Implement link command core logic",
      "description": "As a developer, I want the link command to parse URLs and insert directives into files.",
      "acceptanceCriteria": [
        "Parse Figma URL using `parseFigmaUrl` utility",
        "Validate target file exists, show error if not",
        "Detect existing directives using `detectDirectives` utility",
        "If no existing directives: insert new directives at top of file",
        "Show success message: `✔ Linked <file> to <fileKey> (node: <nodeId>)`",
        "If URL has no node ID: show warning that file won't be tracked",
        "Use ora spinner during file operations",
        "Use kleur for colored output",
        "Typecheck passes"
      ],
      "priority": 9,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-010",
      "title": "Implement conflict resolution for existing directives",
      "description": "As a developer, I want the link command to handle files that already have directives.",
      "acceptanceCriteria": [
        "If file has existing directives and no flags: prompt user with options",
        "Prompt options: 'Add node to existing', 'Replace all', 'Cancel'",
        "'Add node' appends new @figma-node line (only if same file key)",
        "'Replace' removes old directives and inserts new ones",
        "'Cancel' aborts without modifying file",
        "Show warning if file keys don't match when adding node",
        "With `--yes` flag: auto-add if same key, auto-replace if different",
        "With `--force` flag: always replace without prompt",
        "Skip duplicate node IDs with info message",
        "Typecheck passes"
      ],
      "priority": 10,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-011",
      "title": "Implement batch linking for multiple files",
      "description": "As a developer, I want to link multiple files in one command.",
      "acceptanceCriteria": [
        "Support multiple `--file` arguments: `link <url> -f file1.tsx -f file2.tsx`",
        "Process each file independently",
        "Show progress for each file",
        "Continue processing remaining files if one fails",
        "Display summary at end: success count, failure count, skipped count",
        "Include warning count in summary if any files linked without node IDs",
        "Typecheck passes"
      ],
      "priority": 11,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-012",
      "title": "Implement interactive mode",
      "description": "As a developer, I want interactive prompts when URL or file is not provided.",
      "acceptanceCriteria": [
        "If URL not provided: prompt 'Enter Figma URL:'",
        "If file not provided: prompt for file path",
        "Validate URL input, re-prompt if invalid",
        "Validate file path, re-prompt if file doesn't exist",
        "After successful link: ask 'Link another file?'",
        "If yes: prompt for another file path (same URL)",
        "If no: exit with summary",
        "Typecheck passes"
      ],
      "priority": 12,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-013",
      "title": "Add link command tests",
      "description": "As a developer, I need tests for the link command.",
      "acceptanceCriteria": [
        "Create `packages/cli/src/__tests__/link.test.ts`",
        "Test basic link command with URL and file",
        "Test --path alias works same as --file",
        "Test error for non-existent file",
        "Test error for invalid URL",
        "Test --yes flag skips confirmation",
        "Test --force flag replaces directives",
        "Test batch linking with multiple files",
        "Test partial batch failure continues processing",
        "All tests pass",
        "Typecheck passes"
      ],
      "priority": 13,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-014",
      "title": "Integrate link option into init command",
      "description": "As a developer, I want the init command to offer linking a file after setup.",
      "acceptanceCriteria": [
        "After config creation in init command, ask 'Would you like to link a Figma file now?'",
        "If yes: prompt for Figma URL and target file",
        "Use same linking logic as link command",
        "If user cancels or link fails: init still completes successfully",
        "With `--yes` flag on init: skip the link prompt entirely",
        "Typecheck passes"
      ],
      "priority": 14,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-015",
      "title": "Update README with link command documentation",
      "description": "As a developer, I want the README to document the new link command.",
      "acceptanceCriteria": [
        "Add `### figma-sentinel link` section after `### figma-sentinel variables` in README.md",
        "Include command syntax with all options",
        "Include usage examples (basic, batch, force)",
        "Add 'How it works' explanation",
        "Update Quick Start section with tip about link command",
        "Add 'Easy Linking' to Features list",
        "Typecheck passes"
      ],
      "priority": 15,
      "passes": false,
      "notes": ""
    }
  ]
}
