{
  "project": "FigmaSentinel",
  "branchName": "ralph/improved-error-handling",
  "description": "Improved Figma API Error Handling & User Notification System - Comprehensive error handling with typed classes, Retry-After support, concurrency control, and event system for future notifications",
  "userStories": [
    {
      "id": "US-001",
      "title": "Create base FigmaSentinelError class",
      "description": "As a developer, I need a base error class with code, message, cause, and isRetryable properties.",
      "acceptanceCriteria": [
        "Create `FigmaSentinelError` class extending Error in `packages/core/src/errors.ts`",
        "Add `code: string` property for error identification",
        "Add `cause?: Error` property for error chaining",
        "Add `isRetryable: boolean` property (default false)",
        "Export from `packages/core/src/index.ts`",
        "Typecheck passes"
      ],
      "priority": 1,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-002",
      "title": "Create FigmaRateLimitError subclass",
      "description": "As a developer, I need a rate limit error class with Figma-specific headers.",
      "acceptanceCriteria": [
        "Create `FigmaRateLimitError` extending `FigmaSentinelError` in `packages/core/src/errors.ts`",
        "Add `retryAfterSec: number` property",
        "Add `planTier?: string` property for X-Figma-Plan-Tier",
        "Add `rateLimitType?: string` property for X-Figma-Rate-Limit-Type",
        "Add `upgradeLink?: string` property for X-Figma-Upgrade-Link",
        "Set `isRetryable: true` by default",
        "Set `code: 'RATE_LIMIT'`",
        "Export from barrel file",
        "Typecheck passes"
      ],
      "priority": 2,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-003",
      "title": "Create remaining error subclasses",
      "description": "As a developer, I need error classes for authentication, not found, server, validation, and network errors.",
      "acceptanceCriteria": [
        "Create `FigmaAuthenticationError` with code 'AUTH_ERROR' for 401/403",
        "Create `FigmaNotFoundError` with code 'NOT_FOUND' for 404, add `fileKey?: string`",
        "Create `FigmaServerError` with code 'SERVER_ERROR' for 500",
        "Create `FigmaValidationError` with code 'VALIDATION_ERROR' for 400",
        "Create `FigmaNetworkError` with code 'NETWORK_ERROR', set `isRetryable: true`",
        "All classes extend `FigmaSentinelError`",
        "Export all from barrel file",
        "Typecheck passes"
      ],
      "priority": 3,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-004",
      "title": "Add unit tests for error classes",
      "description": "As a developer, I need tests to verify all error classes work correctly.",
      "acceptanceCriteria": [
        "Create `packages/core/src/__tests__/errors.test.ts`",
        "Test `FigmaSentinelError` properties and inheritance from Error",
        "Test `FigmaRateLimitError` has correct properties and isRetryable=true",
        "Test all other error classes have correct code and properties",
        "Test error chaining with cause property",
        "Typecheck passes",
        "All tests pass: `pnpm -F @khoavhd/figma-sentinel-core test src/__tests__/errors.test.ts`"
      ],
      "priority": 4,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-005",
      "title": "Create error response parser",
      "description": "As a developer, I need to parse Figma API error responses in both formats.",
      "acceptanceCriteria": [
        "Create `parseErrorResponse(response: Response)` in `packages/core/src/error-parser.ts`",
        "Handle `{status, err}` format (ErrorResponsePayloadWithErrMessage)",
        "Handle `{error: true, status, message}` format (ErrorResponsePayloadWithErrorBoolean)",
        "Return structured object with status, message, and parsed headers",
        "Export from barrel file",
        "Typecheck passes"
      ],
      "priority": 5,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-006",
      "title": "Parse rate limit headers",
      "description": "As a developer, I need to extract rate limit metadata from response headers.",
      "acceptanceCriteria": [
        "Create `parseRateLimitHeaders(headers: Headers)` function in `packages/core/src/error-parser.ts`",
        "Extract `Retry-After` header as number (seconds)",
        "Extract `X-Figma-Plan-Tier` header",
        "Extract `X-Figma-Rate-Limit-Type` header",
        "Extract `X-Figma-Upgrade-Link` header",
        "Return typed object with all fields optional",
        "Typecheck passes"
      ],
      "priority": 6,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-007",
      "title": "Add unit tests for error parser",
      "description": "As a developer, I need tests for error response and header parsing.",
      "acceptanceCriteria": [
        "Create `packages/core/src/__tests__/error-parser.test.ts`",
        "Test parsing `{status, err}` format",
        "Test parsing `{error: true, status, message}` format",
        "Test header extraction with all headers present",
        "Test header extraction with missing headers",
        "Test Retry-After parsing as number",
        "Typecheck passes",
        "All tests pass: `pnpm -F @khoavhd/figma-sentinel-core test src/__tests__/error-parser.test.ts`"
      ],
      "priority": 7,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-008",
      "title": "Update fetchWithRetry to use Retry-After header",
      "description": "As a user, I want retry logic to respect Figma's Retry-After header.",
      "acceptanceCriteria": [
        "Modify `fetchWithRetry` in `packages/core/src/figma-client.ts`",
        "On 429, read Retry-After header using `parseRateLimitHeaders`",
        "If Retry-After present, use that value instead of exponential backoff",
        "If Retry-After missing, fall back to current exponential backoff",
        "Log retry with wait time using console.warn",
        "Typecheck passes"
      ],
      "priority": 8,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-009",
      "title": "Add max retry delay abort behavior",
      "description": "As a user, I want retries to abort if wait time is too long.",
      "acceptanceCriteria": [
        "Add `MAX_RETRY_DELAY_MS` constant (default 3600000 = 1 hour)",
        "In fetchWithRetry, check if Retry-After exceeds MAX_RETRY_DELAY_MS",
        "If exceeded, throw FigmaRateLimitError with upgradeLink from headers",
        "Include message about wait being too long",
        "Typecheck passes"
      ],
      "priority": 9,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-010",
      "title": "Add unit tests for retry logic",
      "description": "As a developer, I need tests for retry behavior with Retry-After support.",
      "acceptanceCriteria": [
        "Create `packages/core/src/__tests__/fetch-retry.test.ts`",
        "Mock fetch to return 429 with Retry-After header",
        "Test that wait time uses Retry-After value",
        "Test fallback to exponential backoff when header missing",
        "Test abort when Retry-After exceeds max delay",
        "Use vitest fake timers for delay testing",
        "Typecheck passes",
        "All tests pass: `pnpm -F @khoavhd/figma-sentinel-core test src/__tests__/fetch-retry.test.ts`"
      ],
      "priority": 10,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-011",
      "title": "Add p-limit dependency and config schema",
      "description": "As a developer, I need concurrency control infrastructure.",
      "acceptanceCriteria": [
        "Add `p-limit` to dependencies in `packages/core/package.json`",
        "Update `SentinelConfig` type to include `api.concurrency` (default: 5)",
        "Update `SentinelConfig` type to include `api.maxRetries` (default: 3)",
        "Update `SentinelConfig` type to include `api.maxRetryDelayMs` (default: 3600000)",
        "Update Zod schema for config validation",
        "Typecheck passes"
      ],
      "priority": 11,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-012",
      "title": "Apply concurrency control to fetchNodes",
      "description": "As a user, I want concurrent API requests limited.",
      "acceptanceCriteria": [
        "Import p-limit in `packages/core/src/figma-client.ts`",
        "Create limiter with concurrency from config (default 5)",
        "Wrap fetchNodesForFileKey calls with limiter",
        "Pass config through to fetchNodes function",
        "Typecheck passes"
      ],
      "priority": 12,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-013",
      "title": "Create Logger interface and ConsoleLogger",
      "description": "As a developer, I need a unified logger abstraction.",
      "acceptanceCriteria": [
        "Create `Logger` interface in `packages/core/src/logger.ts` with debug, info, warn, error methods",
        "Create `ConsoleLogger` class implementing Logger",
        "Use console.log for info, console.warn for warn, console.error for error",
        "Add `logLevel` option to filter messages (debug, info, warn, error)",
        "Export from barrel file",
        "Typecheck passes"
      ],
      "priority": 13,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-014",
      "title": "Add unit tests for Logger",
      "description": "As a developer, I need tests for logger implementations.",
      "acceptanceCriteria": [
        "Create `packages/core/src/__tests__/logger.test.ts`",
        "Test ConsoleLogger calls correct console methods",
        "Test log level filtering (e.g., warn level filters out debug/info)",
        "Mock console methods to verify output",
        "Typecheck passes",
        "All tests pass: `pnpm -F @khoavhd/figma-sentinel-core test src/__tests__/logger.test.ts`"
      ],
      "priority": 14,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-015",
      "title": "Create actionable error message generator",
      "description": "As a user, I want clear error messages with guidance.",
      "acceptanceCriteria": [
        "Create `generateErrorMessage(error: FigmaSentinelError, context?: {fileKey?, nodeId?})` in `packages/core/src/error-messages.ts`",
        "400: 'Invalid request: [detail]. Check Figma URL format or reduce request size.'",
        "401: 'Authentication failed. Verify your FIGMA_TOKEN is valid and not expired.'",
        "403: 'Access denied for file [key]. Check: 1) Token has file_read scope 2) You have view access 3) Enterprise plan for Variables.'",
        "404: 'Figma file [key] not found. Verify the file key from your Figma URL.'",
        "429: 'Rate limit exceeded. Waiting [X]s. Tier: [tier], Type: [type]. Upgrade: [link]'",
        "500: 'Figma server error. Try reducing nodes requested or try again later.'",
        "Network: 'Network error connecting to Figma API. Check your internet connection.'",
        "Typecheck passes"
      ],
      "priority": 15,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-016",
      "title": "Add unit tests for error messages",
      "description": "As a developer, I need tests for error message generation.",
      "acceptanceCriteria": [
        "Create `packages/core/src/__tests__/error-messages.test.ts`",
        "Test message for each error code (400, 401, 403, 404, 429, 500, network)",
        "Test context interpolation (fileKey, nodeId)",
        "Test rate limit message includes tier, type, upgrade link",
        "Typecheck passes",
        "All tests pass: `pnpm -F @khoavhd/figma-sentinel-core test src/__tests__/error-messages.test.ts`"
      ],
      "priority": 16,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-017",
      "title": "Create ErrorAggregator class",
      "description": "As a user, I want errors collected and summarized.",
      "acceptanceCriteria": [
        "Create `ErrorAggregator` class in `packages/core/src/error-aggregator.ts`",
        "Add `addError(error, context)` method",
        "Add `getErrors()` method returning all collected errors",
        "Add `getSummary()` method returning grouped summary by error type and file key",
        "Add `getSuccessCount()` and `getFailureCount()` methods",
        "Export from barrel file",
        "Typecheck passes"
      ],
      "priority": 17,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-018",
      "title": "Add unit tests for ErrorAggregator",
      "description": "As a developer, I need tests for error aggregation.",
      "acceptanceCriteria": [
        "Create `packages/core/src/__tests__/error-aggregator.test.ts`",
        "Test adding multiple errors",
        "Test getSummary groups by error type",
        "Test getSummary groups by file key",
        "Test success/failure counts",
        "Typecheck passes",
        "All tests pass: `pnpm -F @khoavhd/figma-sentinel-core test src/__tests__/error-aggregator.test.ts`"
      ],
      "priority": 18,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-019",
      "title": "Implement fail-fast behavior in fetchNodes",
      "description": "As a user, I want execution to stop on first error.",
      "acceptanceCriteria": [
        "Modify `fetchNodes` to throw immediately on any error instead of collecting",
        "Throw typed error (FigmaNotFoundError, FigmaAuthenticationError, etc.) based on status",
        "Include fileKey and nodeId in error context",
        "Remove errors array from FetchResult (now throws instead)",
        "Typecheck passes"
      ],
      "priority": 19,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-020",
      "title": "Add unit tests for fail-fast behavior",
      "description": "As a developer, I need tests for fail-fast execution.",
      "acceptanceCriteria": [
        "Create `packages/core/src/__tests__/fail-fast.test.ts`",
        "Mock fetch to return error on second request",
        "Verify execution stops after first error",
        "Verify correct error type is thrown",
        "Verify error contains context (fileKey, nodeId)",
        "Typecheck passes",
        "All tests pass: `pnpm -F @khoavhd/figma-sentinel-core test src/__tests__/fail-fast.test.ts`"
      ],
      "priority": 20,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-021",
      "title": "Create ErrorEventEmitter class",
      "description": "As a developer, I need an event system for future notification integrations.",
      "acceptanceCriteria": [
        "Create `ErrorEventEmitter` class in `packages/core/src/error-events.ts`",
        "Extend Node.js EventEmitter",
        "Define typed events: 'error', 'retry', 'rateLimited', 'completed'",
        "Each event payload includes: type, error/details, context, timestamp",
        "Add `createEventEmitter()` factory function",
        "Export from barrel file",
        "Typecheck passes"
      ],
      "priority": 21,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-022",
      "title": "Add unit tests for ErrorEventEmitter",
      "description": "As a developer, I need tests for event emission.",
      "acceptanceCriteria": [
        "Create `packages/core/src/__tests__/error-events.test.ts`",
        "Test 'error' event emitted with correct payload",
        "Test 'retry' event emitted with retry count and delay",
        "Test 'rateLimited' event emitted with headers info",
        "Test 'completed' event emitted with success/failure counts",
        "Typecheck passes",
        "All tests pass: `pnpm -F @khoavhd/figma-sentinel-core test src/__tests__/error-events.test.ts`"
      ],
      "priority": 22,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-023",
      "title": "Integrate events into fetchWithRetry",
      "description": "As a developer, I need retry events emitted during fetch.",
      "acceptanceCriteria": [
        "Accept optional `eventEmitter` in fetchWithRetry options",
        "Emit 'retry' event before each retry attempt",
        "Emit 'rateLimited' event when 429 received with header info",
        "Emit 'error' event when max retries exceeded",
        "Typecheck passes"
      ],
      "priority": 23,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-024",
      "title": "Add --verbose flag to CLI",
      "description": "As a CLI user, I want debug-level output when needed.",
      "acceptanceCriteria": [
        "Add `--verbose` or `-v` flag to sync command in `packages/cli/src/commands/sync.ts`",
        "When verbose, set logger level to 'debug'",
        "Debug output includes API URLs, response times, headers",
        "Default logger level is 'info'",
        "Typecheck passes"
      ],
      "priority": 24,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-025",
      "title": "Update CLI error output with colors",
      "description": "As a CLI user, I want color-coded error output.",
      "acceptanceCriteria": [
        "Use kleur for colored output in sync command",
        "Rate limit retries show spinner with countdown in yellow",
        "Errors show in red with actionable message from generateErrorMessage",
        "Success shows in green",
        "Typecheck passes"
      ],
      "priority": 25,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-026",
      "title": "Add CLI tests for error output",
      "description": "As a developer, I need tests for CLI error scenarios.",
      "acceptanceCriteria": [
        "Create or update `packages/cli/src/__tests__/sync.test.ts`",
        "Mock runSentinel to throw different error types",
        "Verify exit code is 1 on error",
        "Verify error message is displayed",
        "Test --verbose flag enables debug output",
        "Typecheck passes",
        "All tests pass: `pnpm -F @khoavhd/figma-sentinel-cli test`"
      ],
      "priority": 26,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-027",
      "title": "Add error-count and error-details outputs to Action",
      "description": "As a GitHub Action user, I want error information in outputs.",
      "acceptanceCriteria": [
        "In `packages/action/src/index.ts`, catch errors from runSentinel",
        "Set output `error-count` with number of errors (0 or 1 since fail-fast)",
        "Set output `error-details` with JSON of error object",
        "Use core.setFailed with actionable message from generateErrorMessage",
        "Typecheck passes"
      ],
      "priority": 27,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-028",
      "title": "Add Action tests for error handling",
      "description": "As a developer, I need tests for Action error scenarios.",
      "acceptanceCriteria": [
        "Create or update `packages/action/src/__tests__/index.test.ts`",
        "Mock @actions/core methods (setFailed, setOutput, info, warning)",
        "Mock runSentinel to throw different error types",
        "Verify core.setFailed called with correct message",
        "Verify error-count and error-details outputs set",
        "Typecheck passes",
        "All tests pass: `pnpm -F @khoavhd/figma-sentinel-action test`"
      ],
      "priority": 28,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-029",
      "title": "Update README with error handling docs",
      "description": "As a user, I need documentation for error handling features.",
      "acceptanceCriteria": [
        "Add 'Error Handling' section to README.md",
        "Document error types and when they occur",
        "Document retry behavior with Retry-After support",
        "Document concurrency config option",
        "Add example for custom error event handlers",
        "Typecheck passes"
      ],
      "priority": 29,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-030",
      "title": "Final verification and cleanup",
      "description": "As a developer, I need to verify everything works together.",
      "acceptanceCriteria": [
        "Run `pnpm test` - all tests pass",
        "Run `pnpm typecheck` - no errors",
        "Run `pnpm lint` - no errors",
        "Run `pnpm build` - builds successfully",
        "All new exports are in barrel files",
        "No console.log statements (only logger)",
        "Typecheck passes"
      ],
      "priority": 30,
      "passes": false,
      "notes": ""
    }
  ]
}
